name: Generate Microsoft Teams Notify JSON
description: "Action to combine the steps of multiple workflow jobs into one object for the notify-microsoft-teams to consume"
inputs:
  needs-context:
    required: true
    description: "The context containing the jobs to combine"
outputs:
  job-context:
    description: "The job context to pass to the Microsoft Teams Notification action"
    value: ${{ steps.ms-teams-json.outputs.job-context }}
  steps-context:
    description: "The steps context to pass to the Microsoft Teams Notification action"
    value: ${{ steps.ms-teams-json.outputs.steps-context }}

runs:
  using: composite
  steps:
    - name: 📝 Generate MS Teams Notify JSON
      id: ms-teams-json
      shell: bash
      run: |
        count=0
        mkdir -p $GITHUB_WORKSPACE/steps  # Ensure the steps directory exists

        for job in $(echo '${{ inputs.needs-context }}' | jq -c '.[]'); do
          job_status=$(echo "$job" | jq -r '.result')
          if [ $job_status == 'failure' ] || [ $job_status == 'cancelled' ]; then
            result=$job_status
          fi
        
          steps_context=$(echo "$job" | jq -r '.outputs.steps-context')
          if [ $steps_context != 'null' ]; then
            echo $steps_context > $GITHUB_WORKSPACE/steps/job-${count}.json
          fi
        
          count=$((count + 1))
        done
        
        if [ $result ]; then
          job_context=$(echo "{\"status\":\"${result}\"}" | jq -c)
        else
          job_context=$(echo "{\"status\":\"success\"}" | jq -c)
        fi
        
        echo "job-context=$job_context" >> $GITHUB_OUTPUT
        echo "steps-context=$(jq -c -s 'reduce .[] as $item ({}; . * $item)' $GITHUB_WORKSPACE/steps/*.json)" >> $GITHUB_OUTPUT
