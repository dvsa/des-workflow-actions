name: Manage NonProd RDS Clusters

on:
  workflow_dispatch:
    inputs:
      action:
        description: RDS Instance Action
        type: choice
        options:
          - start
          - stop
      environment:
        description: RDS Instance Environment
        type: choice
        options:
          - uat
          - perf
  schedule:
#    - cron: "45 05,18 * * 1-5"
    - cron: "45 01,13 * * 1-5" # For testing

permissions:
  id-token: write
  contents: write

jobs:
  manage-nonprod-clusters:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¨ Checkout
        uses: actions/checkout@v4

      - name: ðŸ•µï¸ Determine Action
        if: ${{ github.event_name == 'schedule' }}
        id: determine-action
        run: |
          if [ $(date +"%H") -lt 12 ]; then
            echo "action=start" >> $GITHUB_OUTPUT
          else
            echo "action=stop" >> $GITHUB_OUTPUT
          fi;

      - name: ðŸ”‘ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions
          aws-region: ${{ secrets.DVSA_AWS_REGION }}

      - name: ðŸ¤« Get Secrets
        uses: aws-actions/aws-secretsmanager-get-secrets@v1
        with:
          secret-ids: |
            des-globals/env
            rds-exclusions-list
          parse-json-secrets: true

      - name: ðŸ”„ Update Exclusions List
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |

          if [ "${{ inputs.action }}" == 'start' ]; then
            exclusions=$(echo ${{ env.RDS_EXCLUSIONS_LIST_ENVIRONMENTS }} | sed 's/${{ inputs.environment }}//; s/  */,/g')
          fi
          
          if [ "${{ inputs.action }}" == 'stop' ]; then
            exclusions="${{ env.RDS_EXCLUSIONS_LIST_ENVIRONMENTS }} ${{ inputs.environment }}"
          fi
          
          outcome=$(aws secretsmanager put-secret-value --secret-id rds-exclusions-list \
          --secret-string "{\"ENVIRONMENTS\":\"$exclusions\"}" > /dev/null; echo $?)
          

          if [ $outcome -eq 0 ]; then
            echo "## Update RDS Exclusions" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Successfully updated the RDS exclusions list" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ”‘ Configure NonProd AWS Credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_NONPROD_ACCOUNT_ID }}:role/github-actions
          aws-region: ${{ secrets.DVSA_AWS_REGION }}

      - name: ðŸ› ï¸ Manage NonProd Clusters
        run: |
          clusters=($(aws rds describe-db-clusters --region eu-west-1 | jq -r '.DBClusters[] | "\(.DBClusterIdentifier),\(.Status)"'))
          action=${{ inputs.action || steps.determine-action.outputs.action }}
                    
          echo "## NonProd RDS Cluster Action Summary" >> $GITHUB_STEP_SUMMARY
          
          for cluster in "${clusters[@]}"; do
            cluster_name=$(echo $cluster | cut -d ',' -f 1)
            cluster_status=$(echo $cluster | cut -d ',' -f 2)
            environment_name=$(echo $cluster | cut -d '-' -f 2)
          

            if [ "$action" == "start" ]; then emoji="ðŸŸ¢"; else emoji="ðŸ”´";  fi

            # Ignore clusters that don't match the input environment for workflow_dispatch runs
            if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "$environment_name" != "${{ inputs.environment }}" ]; then
              echo "Skipping $cluster_name"
              continue
            fi
          
            # Handle if any clusters have been manually changed in the AWS console

            if [[ ( "$action" == "start" && "$cluster_status" == "available" ) || ( "$action" == "stop" && "$cluster_status" == "stopped" ) ]]; then
              echo "$emoji $cluster_name is already in the desired state" >> $GITHUB_STEP_SUMMARY
              continue
            fi
          

            if [ "$action" == "start" ]; then         
              # Check if the environment is in the exclusion list (0 = excluded, 1 = not excluded)
              is_excluded=$(echo $environment_name | \
              grep -q "$(echo ${{ env.RDS_EXCLUSIONS_LIST_ENVIRONMENTS }} | sed 's/ /\\|/g')"; echo $?)
              

              if [ $is_excluded -eq 0 ]; then
                echo "ðŸš« $cluster_name is in the exclusion list so won't be actioned" >> $GITHUB_STEP_SUMMARY
              else
                echo "$emoji Starting cluster: $cluster_name" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          
            if [ "$action" == "stop" ]; then
              echo "$emoji Stopping cluster: $cluster_name" >> $GITHUB_STEP_SUMMARY
            fi
          done
