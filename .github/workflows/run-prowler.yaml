name: 👮 Run Prowler

on:
  workflow_dispatch:
    inputs:
      runner:
        description: The EC2 GHA runner label
        type: string
        required: true
      aws-account:
        description: The AWS account to run prowler in
        type: string
        required: true
      aws-region:
        description: AWS Region to run prowler in
        type: string
        required: true
      additional-args:
        description: Additional Arguments
        type: string
        required: true

permissions:
  id-token: write
  contents: write

jobs:
  run-prowler:
    runs-on: ${{ inputs.runner }}
    steps:
      - name: 📨 Checkout
        uses: actions/checkout@v4

      - name: ⚙️ Setup Python 3.x
        uses: actions/setup-python@v4
        with:
          python-version: 3.9

      - name: ➕ Install Prowler
        run: pip install prowler

      - name: 🔍 Get AWS Account ID
        id: get_account_id
        run: |
          case "${{ inputs.aws-account }}" in
            mgmt) account_id="${{ secrets.AWS_ACCOUNT_ID }}" ;;
            nonprod) account_id="${{ secrets.AWS_NONPROD_ACCOUNT_ID }}" ;;
            prod) account_id="${{ secrets.AWS_PROD_ACCOUNT_ID }}" ;;
          esac
          
          echo "aws-account=${account_id}" >> $GITHUB_OUTPUT

      - name: 🔑 Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ steps.get_account_id.outputs.aws-account }}:role/github-actions
          aws-region: ${{ inputs.aws-region }}

      - name: 👮 Run Prowler
        run: |
          [ -n "${{ inputs.aws-region }}" ] && region_arg="--region ${{ inputs.aws-region }}" || region_arg=""
          prowler aws $region_arg ${{ inputs.additional-args }}

      - name: ☁️ Upload to GitHub Summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.aws-account }}-compliance-results
          path: output/compliance/
          retention-days: 3
