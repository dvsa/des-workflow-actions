name: 👮 Run Prowler

on:
  workflow_call:
    inputs:
      runner:
        description: The EC2 GHA runner label
        type: string
        required: true
      aws-account:
        description: The AWS account to run prowler in
        type: string
        required: true
      aws-region:
        description: AWS Region to run prowler in
        type: string
        required: true
      additional-args:
        description: Additional Arguments
        type: string
        required: true

permissions:
  id-token: write
  contents: write

jobs:
  run-prowler:
    runs-on: ${{ inputs.runner }}
    env:
      RUNNER_TOOL_CACHE: ${{ github.workspace }}/_work/_tool
      AGENT_TOOLSDIRECTORY: ${{ github.workspace }}/_work/_tool
    steps:
      - name: 📨 Checkout
        uses: actions/checkout@v4

#      - name: ⚙️ Python Self Hosted Requirements
#        run: |
#          sudo mkdir -p /opt/github-runner/tools
#          sudo chown ec2-user:ec2-user /opt/github-runner/tools
#          export AGENT_TOOLSDIRECTORY=/opt/github-runner/tools

#      - name : Apt-update
#        run: sudo apt-get update
#      - name: Install lsb-release
#        run: sudo apt-get install -y lsb-release

#      - name: ⚙️ Setup Python 3.x
#        uses: actions/setup-python@v5
##        env:
##          AGENT_TOOLSDIRECTORY: /etc/os-release
#        with:
#          python-version: 3.x

      - name: ➕ Install Pip
        run: sudo dnf install python3-pip -y

      - name: ➕ Install Prowler
        run: pip3 install prowler

      - name: 🔍 Get AWS Account ID
        id: get_account_id
        run: |
          case "${{ inputs.aws-account }}" in
            mgmt) account_id="${{ secrets.AWS_ACCOUNT_ID }}" ;;
            nonprod) account_id="${{ secrets.AWS_NONPROD_ACCOUNT_ID }}" ;;
            prod) account_id="${{ secrets.AWS_PROD_ACCOUNT_ID }}" ;;
          esac
          
          echo "aws-account=${account_id}" >> $GITHUB_OUTPUT

      - name: 🔑 Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ steps.get_account_id.outputs.aws-account }}:role/github-actions
          aws-region: ${{ inputs.aws-region }}

      - name: 👮 Run Prowler
        run: |
          [ -n "${{ inputs.aws-region }}" ] && region_arg="--region ${{ inputs.aws-region }}" || region_arg=""
          prowler aws $region_arg ${{ inputs.additional-args }}

      - name: ☁️ Upload to GitHub Summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.aws-account }}-compliance-results
          path: output/compliance/
          retention-days: 3
